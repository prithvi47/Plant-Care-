<html>
{% extends 'base.html' %}
{% block pagetitle %}
PlantCare AI Engine
{% endblock pagetitle %}

{% block body %}
<div class="plantcare-container">
    <div class="container">
        <!-- Header Section -->
        <div class="row mb-5 text-center">
            <div class="col-lg-10 mx-auto">
                <h1 class="display-4 plantcare-title">
                    <span class="leaf-icon">ðŸŒ¿</span> 
                    <b>PlantCare</b> 
                    <span class="leaf-icon">ðŸŒ±</span>
                </h1>
                <p class="lead plantcare-subtitle">AI-powered plant disease detection for healthier gardens</p>
                <div class="divider"></div>
            </div>
        </div>
        
        <!-- Main Content Section -->
        <div class="row g-4">
            <!-- Left Panel - Information -->
            <div class="col-lg-4">
                <div class="p-5 plantcare-card h-100">
                    <div class="info-icon">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <h5 class="card-title"><b>Why detect plant diseases early?</b></h5>
                    <div class="card-content">
                        <p>Plant diseases can significantly impact growth and yield. Early detection is crucial because:</p>
                        <ul class="plantcare-list">
                            <li><i class="fas fa-seedling"></i> Prevents spread to other plants</li>
                            <li><i class="fas fa-clock"></i> Saves time and money on treatments</li>
                            <li><i class="fas fa-leaf"></i> Maintains plant health before symptoms worsen</li>
                            <li><i class="fas fa-utensils"></i> Ensures better crop quality and food safety</li>
                        </ul>
                        <div class="stats-box">
                            <div class="stat-item">
                                <div class="stat-value">90%</div>
                                <div class="stat-label">Detection Accuracy</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">48h</div>
                                <div class="stat-label">Early Detection</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center Panel - Upload/Camera -->
            <div class="col-lg-4">
                <div class="p-5 plantcare-card upload-card h-100">
                    <div class="upload-icon">
                        <i class="fas fa-camera-retro"></i>
                    </div>
                    <h5 class="card-title"><b>Scan Your Plant</b></h5>
                    
                    <form action="/submit" method="POST" enctype="multipart/form-data" id="plantForm">
                        <!-- File Upload Section -->
                        <div class="upload-section">
                            <div class="upload-options">
                                <div class="upload-option active" id="uploadOption">
                                    <i class="fas fa-file-upload"></i> Upload
                                </div>
                                <div class="upload-option" id="cameraOption">
                                    <i class="fas fa-camera"></i> Camera
                                </div>
                            </div>
                            
                            <!-- File Upload Box -->
                            <div class="upload-box" id="fileUploadBox">
                                <i class="fas fa-cloud-upload-alt upload-icon-large"></i>
                                <p class="upload-text">Drag & drop your plant image here</p>
                                <p class="upload-text-secondary">or</p>
                                <label for="actual-btn" class="btn-upload">
                                    Browse Files
                                    <input type="file" id="actual-btn" hidden name="image" accept="image/*" />
                                </label>
                                <p class="file-info" id="file-chosen">No file selected</p>
                            </div>
                            
                            <!-- Camera Box -->
                            <div class="camera-box" id="cameraBox" style="display: none;">
                                <div class="camera-container" id="cameraContainer">
                                    <video id="camera-feed" autoplay playsinline></video>
                                    <div class="camera-controls">
                                        <button type="button" id="switchCamera" class="btn-camera-control">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button type="button" id="capture-btn" class="btn-capture">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                        <button type="button" id="closeCamera" class="btn-camera-control">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <canvas id="photoCanvas" style="display: none;"></canvas>
                                <img id="photoPreview" class="photo-preview" style="display: none;" />
                            </div>
                        </div>
                        
                        <div class="upload-hint">
                            <i class="fas fa-lightbulb"></i> For best results, take a clear photo of the affected leaves against a plain background.
                        </div>
                        
                        <button type="submit" class="btn-submit" id="submitBtn" disabled>
                            <i class="fas fa-search"></i> Analyze Plant
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Right Panel - Prevention Tips -->
            <div class="col-lg-4">
                <div class="p-5 plantcare-card h-100">
                    <div class="prevention-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h5 class="card-title"><b>Prevention Tips</b></h5>
                    <div class="card-content">
                        <div class="prevention-tip">
                            <div class="tip-number">1</div>
                            <div class="tip-content">
                                <h6>Practice Good Sanitation</h6>
                                <p>Clean tools and remove diseased plant debris regularly.</p>
                            </div>
                        </div>
                        <div class="prevention-tip">
                            <div class="tip-number">2</div>
                            <div class="tip-content">
                                <h6>Proper Fertilization</h6>
                                <p>Keep plants healthy with balanced nutrition.</p>
                            </div>
                        </div>
                        <div class="prevention-tip">
                            <div class="tip-number">3</div>
                            <div class="tip-content">
                                <h6>Inspect New Plants</h6>
                                <p>Check for diseases before introducing to your garden.</p>
                            </div>
                        </div>
                        <div class="prevention-tip">
                            <div class="tip-number">4</div>
                            <div class="tip-content">
                                <h6>Ensure Air Circulation</h6>
                                <p>Space plants properly to reduce humidity.</p>
                            </div>
                        </div>
                        
                        <div class="more-info">
                            <a href="https://www.thespruce.com/prevent-plant-diseases-in-your-garden-2539511" target="_blank" class="btn-more-info">
                                <i class="fas fa-book-open"></i> More Prevention Tips
                            </a>
                        </div>
                        
                        <div class="disease-library">
                            <h6><i class="fas fa-book-medical"></i> Common Plant Diseases</h6>
                            <div class="disease-tags">
                                <span class="disease-tag">Powdery Mildew</span>
                                <span class="disease-tag">Leaf Spot</span>
                                <span class="disease-tag">Blight</span>
                                <span class="disease-tag">Rust</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- How It Works Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="how-it-works">
                    <h3><i class="fas fa-cogs"></i> How PlantCare Works</h3>
                    <div class="steps-container">
                        <div class="step">
                            <div class="step-icon">1</div>
                            <h5>Upload Image</h5>
                            <p>Take or upload a clear photo of your plant's leaves</p>
                        </div>
                        <div class="step-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="step">
                            <div class="step-icon">2</div>
                            <h5>AI Analysis</h5>
                            <p>Our deep learning model analyzes the image</p>
                        </div>
                        <div class="step-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="step">
                            <div class="step-icon">3</div>
                            <h5>Get Results</h5>
                            <p>Receive instant diagnosis and treatment recommendations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-color: #2e7d32;
        --primary-light: #60ad5e;
        --primary-dark: #005005;
        --secondary-color: #f5f5f5;
        --accent-color: #8bc34a;
        --text-color: #333;
        --light-text: #666;
        --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .plantcare-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4f5e4 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .plantcare-title {
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 1rem;
        position: relative;
    }
    
    .plantcare-title .leaf-icon {
        display: inline-block;
        animation: float 3s ease-in-out infinite;
    }
    
    .plantcare-title .leaf-icon:first-child {
        animation-delay: 0.5s;
    }
    
    .plantcare-title .leaf-icon:last-child {
        animation-delay: 1s;
    }
    
    .plantcare-subtitle {
        font-weight: 500;
        color: var(--primary-light);
        margin-bottom: 1.5rem;
    }
    
    .divider {
        height: 3px;
        width: 100px;
        background: var(--accent-color);
        margin: 0 auto;
        border-radius: 3px;
    }
    
    .plantcare-card {
        background: white;
        border-radius: 15px;
        box-shadow: var(--card-shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .plantcare-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    
    .plantcare-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }
    
    .card-title {
        color: var(--primary-dark);
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
        position: relative;
    }
    
    .card-title::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 50px;
        height: 2px;
        background: var(--accent-color);
    }
    
    .plantcare-list {
        list-style: none;
        padding-left: 0;
    }
    
    .plantcare-list li {
        padding: 0.5rem 0;
        border-bottom: 1px dashed #eee;
        display: flex;
        align-items: center;
    }
    
    .plantcare-list li i {
        margin-right: 10px;
        color: var(--primary-light);
        width: 20px;
        text-align: center;
    }
    
    .info-icon, .prevention-icon, .upload-icon {
        font-size: 2.5rem;
        color: var(--primary-light);
        margin-bottom: 1rem;
        text-align: center;
    }
    
    /* Upload Card Styles */
    .upload-card {
        background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
    }
    
    .upload-section {
        margin-bottom: 1.5rem;
    }
    
    .upload-options {
        display: flex;
        margin-bottom: 1rem;
        border-radius: 10px;
        overflow: hidden;
        background: #f5f5f5;
    }
    
    .upload-option {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-option.active {
        background: var(--primary-color);
        color: white;
    }
    
    .upload-option i {
        margin-right: 8px;
    }
    
    .upload-box {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 2rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .upload-box:hover {
        border-color: var(--primary-light);
        background: #f9f9f9;
    }
    
    .upload-box.drag-over {
        border-color: var(--primary-color);
        background: #f0fff0;
    }
    
    .upload-icon-large {
        font-size: 3rem;
        color: var(--primary-light);
        margin-bottom: 1rem;
    }
    
    .upload-text {
        color: var(--light-text);
        margin-bottom: 0.5rem;
    }
    
    .upload-text-secondary {
        color: #999;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
    
    .btn-upload {
        display: inline-block;
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn-upload:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }
    
    .file-info {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: var(--light-text);
    }
    
    /* Camera Styles */
    .camera-box {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .camera-container {
        position: relative;
        width: 100%;
        background: #000;
    }
    
    #camera-feed {
        display: block;
        width: 100%;
        height: auto;
    }
    
    .camera-controls {
        position: absolute;
        bottom: 10px;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
    }
    
    .btn-capture {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--primary-color);
        margin: 0 15px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--primary-color);
        font-size: 1.2rem;
    }
    
    .btn-camera-control {
        background: rgba(255,255,255,0.3);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .photo-preview {
        width: 100%;
        border-radius: 10px;
        margin-top: 1rem;
    }
    
    /* Prevention Tips */
    .prevention-tip {
        display: flex;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed #eee;
    }
    
    .tip-number {
        width: 30px;
        height: 30px;
        background: var(--primary-light);
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .tip-content h6 {
        color: var(--primary-dark);
        margin-bottom: 0.3rem;
    }
    
    .tip-content p {
        color: var(--light-text);
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    
    .btn-more-info {
        display: block;
        text-align: center;
        background: var(--primary-light);
        color: white;
        padding: 0.5rem;
        border-radius: 5px;
        margin: 1.5rem 0;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .btn-more-info:hover {
        background: var(--primary-dark);
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-more-info i {
        margin-right: 8px;
    }
    
    .disease-library {
        margin-top: 1.5rem;
    }
    
    .disease-library h6 {
        color: var(--primary-dark);
        margin-bottom: 0.8rem;
    }
    
    .disease-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .disease-tag {
        background: #e8f5e9;
        color: var(--primary-dark);
        padding: 0.3rem 0.8rem;
        border-radius: 50px;
        font-size: 0.8rem;
    }
    
    /* Stats Box */
    .stats-box {
        display: flex;
        justify-content: space-around;
        margin: 1.5rem 0;
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 10px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: var(--light-text);
    }
    
    /* Submit Button */
    .btn-submit {
        display: block;
        width: 100%;
        background: var(--primary-color);
        color: white;
        padding: 0.8rem;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
    }
    
    .btn-submit:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
    }
    
    .btn-submit:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-submit i {
        margin-right: 8px;
    }
    
    /* Upload Hint */
    .upload-hint {
        background: #fff8e1;
        padding: 0.8rem;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #5d4037;
        margin: 1rem 0;
    }
    
    .upload-hint i {
        color: #ffb300;
        margin-right: 8px;
    }
    
    /* How It Works Section */
    .how-it-works {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: var(--card-shadow);
        margin-top: 3rem;
    }
    
    .how-it-works h3 {
        color: var(--primary-dark);
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .how-it-works h3 i {
        margin-right: 10px;
        color: var(--primary-light);
    }
    
    .steps-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-wrap: wrap;
    }
    
    .step {
        flex: 1;
        min-width: 200px;
        text-align: center;
        padding: 0 1.5rem;
    }
    
    .step-icon {
        width: 60px;
        height: 60px;
        background: var(--primary-light);
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 auto 1rem;
    }
    
    .step h5 {
        color: var(--primary-dark);
        margin-bottom: 0.8rem;
    }
    
    .step p {
        color: var(--light-text);
        font-size: 0.9rem;
    }
    
    .step-arrow {
        display: flex;
        align-items: center;
        padding: 0 1rem;
        color: var(--primary-light);
        font-size: 1.5rem;
    }
    
    /* Animations */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    /* Responsive Design */
    @media (max-width: 992px) {
        .steps-container {
            flex-direction: column;
            align-items: center;
        }
        
        .step {
            margin-bottom: 2rem;
        }
        
        .step-arrow {
            transform: rotate(90deg);
            padding: 1rem 0;
        }
    }
    
    @media (max-width: 768px) {
        .plantcare-card {
            margin-bottom: 2rem;
        }
        
        .upload-options {
            flex-direction: column;
        }
        
        .upload-option {
            padding: 0.8rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const actualBtn = document.getElementById('actual-btn');
        const fileChosen = document.getElementById('file-chosen');
        const uploadOption = document.getElementById('uploadOption');
        const cameraOption = document.getElementById('cameraOption');
        const fileUploadBox = document.getElementById('fileUploadBox');
        const cameraBox = document.getElementById('cameraBox');
        const submitBtn = document.getElementById('submitBtn');
        const plantForm = document.getElementById('plantForm');
        
        let currentStream = null;
        let facingMode = "environment"; // Default to rear camera
        let capturedPhoto = null;

        // Toggle between upload and camera options
        uploadOption.addEventListener('click', function() {
            this.classList.add('active');
            cameraOption.classList.remove('active');
            fileUploadBox.style.display = 'block';
            cameraBox.style.display = 'none';
            stopCamera();
        });

        cameraOption.addEventListener('click', function() {
            this.classList.add('active');
            uploadOption.classList.remove('active');
            fileUploadBox.style.display = 'none';
            cameraBox.style.display = 'block';
            startCamera();
        });

        // File upload handling
        actualBtn.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileChosen.textContent = this.files[0].name;
                submitBtn.disabled = false;
                
                // Show preview
                const preview = document.getElementById('photoPreview');
                const file = this.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    capturedPhoto = file;
                }
                
                reader.readAsDataURL(file);
            } else {
                fileChosen.textContent = 'No file selected';
                submitBtn.disabled = true;
            }
        });

        // Drag and drop functionality
        fileUploadBox.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        fileUploadBox.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });

        fileUploadBox.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length) {
                actualBtn.files = e.dataTransfer.files;
                const event = new Event('change');
                actualBtn.dispatchEvent(event);
            }
        });

        // Camera functionality
        function startCamera() {
            stopCamera(); // Stop any existing stream
            
            const constraints = {
                video: { 
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    const video = document.getElementById('camera-feed');
                    video.srcObject = stream;
                    currentStream = stream;
                })
                .catch(function(err) {
                    console.error("Camera error: ", err);
                    alert("Could not access the camera. Please check permissions.");
                });
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        // Switch camera
        document.getElementById('switchCamera').addEventListener('click', function() {
            facingMode = facingMode === "user" ? "environment" : "user";
            startCamera();
        });

        // Close camera
        document.getElementById('closeCamera').addEventListener('click', function() {
            stopCamera();
            uploadOption.click(); // Switch back to upload option
        });

        // Capture photo
        document.getElementById('capture-btn').addEventListener('click', function() {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('photoCanvas');
            const preview = document.getElementById('photoPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to blob and create a file
            canvas.toBlob(function(blob) {
                capturedPhoto = new File([blob], 'captured_plant.jpg', { type: 'image/jpeg' });
                
                // Create a data transfer object to simulate file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(capturedPhoto);
                actualBtn.files = dataTransfer.files;
                
                // Update UI
                fileChosen.textContent = 'Photo captured';
                preview.src = canvas.toDataURL('image/jpeg');
                preview.style.display = 'block';
                submitBtn.disabled = false;
                
                // Stop camera after capture
                stopCamera();
            }, 'image/jpeg', 0.9);
        });

        // Form submission handler
        plantForm.addEventListener('submit', function(e) {
            if (!capturedPhoto && actualBtn.files.length === 0) {
                e.preventDefault();
                alert('Please select or capture an image first.');
                return;
            }
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            submitBtn.disabled = true;
        });

        // Initialize with upload option active
        uploadOption.click();
    });
</script>

{% endblock body %}